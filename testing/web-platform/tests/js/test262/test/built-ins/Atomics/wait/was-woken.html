<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>js/test262/built-ins/Atomics/wait/was-woken.html</title>

    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
    <script src="/resources/test262-worker-harness.js?pipe=sub"></script>
    <script src="/resources/test262-harness.js"></script>

  </head>
  <body>
  </body>
  <script type="text/javascript">
    // Copyright (C) 2017 Mozilla Corporation.  All rights reserved.
    // This code is governed by the BSD license found in the LICENSE file.

    /*---
    esid: sec-atomics.wait
    description: >
      Test that Atomics.wait returns the right result when it was awoken.
    ---*/
    let attrs = {};
    function test262() {
      return "" +
        "let w = createWorkerFromString(`\n" +
        "    onmessage = function(e) {\n" +
        "      let ia = new Int32Array(e.data[0]);\n" +
        "      let ret = Atomics.wait(ia, 0, 0); // No timeout => Infinity\n" +
        "      postMessage([ret]);\n" +
        "    }\n" +
        "`);\n" +
        "w.onmessage = function(e) {\n" +
        "  assert.sameValue(e.data[0], \"ok\");\n" +
        "  exitEventLoop(w);\n" +
        "}\n" +
        "let ia = new Int32Array(new SharedArrayBuffer(Int32Array.BYTES_PER_ELEMENT));\n" +
        "w.postMessage([ia.buffer]);\n" +
        "// Give the agent a chance to wait.\n" +
        "setTimeout(() => Atomics.wake(ia, 0), 500);\n" +
        "enterEventLoop();\n";
    }
    window.addEventListener('load', function(e) {
      async_test(function(t) {
        run_in_iframe_strict(test262, attrs, t);
      }, 'IFrame (strict): js/test262/built-ins/Atomics/wait/was-woken.html');
      async_test(function(t) {
        run_in_iframe(test262, attrs, t);
      }, 'IFrame: js/test262/built-ins/Atomics/wait/was-woken.html');
      async_test(function(t) {
        run_in_window_strict(test262, attrs, t);
      }, 'Window (strict): js/test262/built-ins/Atomics/wait/was-woken.html');
      async_test(function(t) {
        run_in_window(test262, attrs, t);
      }, 'Window: js/test262/built-ins/Atomics/wait/was-woken.html');
      async_test(function(t) {
        run_in_worker_strict(test262, attrs, t);
      }, 'Worker (strict): js/test262/built-ins/Atomics/wait/was-woken.html');
      async_test(function(t) {
        run_in_worker(test262, attrs, t);
      }, 'Worker: js/test262/built-ins/Atomics/wait/was-woken.html');
      async_test(function(t) {
        run_in_shared_worker_strict(test262, attrs, t);
      }, 'SharedWorker (strict): js/test262/built-ins/Atomics/wait/was-woken.html');
      async_test(function(t) {
        run_in_shared_worker(test262, attrs, t);
      }, 'SharedWorker: js/test262/built-ins/Atomics/wait/was-woken.html');
    });
  </script>
</html>
