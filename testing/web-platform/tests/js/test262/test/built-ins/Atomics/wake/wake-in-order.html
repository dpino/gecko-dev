<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>js/test262/built-ins/Atomics/wake/wake-in-order.html</title>

    <script src="/resources/testharness.js"></script>
    <script src="/resources/testharnessreport.js"></script>
    <script src="/resources/test262-worker-harness.js?pipe=sub"></script>
    <script src="/resources/test262-harness.js"></script>

  </head>
  <body>
  </body>
  <script type="text/javascript">
    // Copyright (C) 2017 Mozilla Corporation.  All rights reserved.
    // This code is governed by the BSD license found in the LICENSE file.

    /*---
    esid: sec-atomics.wake
    description: >
      Test that Atomics.wake wakes agents in the order they are waiting.
    ---*/
    let attrs = {};
    function test262() {
		return "" +
      "let NUMAGENT = 3;\n" +
			"\n" +
			"let WAKEUP = 0;                 // Waiters on this will be woken\n" +
			"let SPIN = 1;                   // Worker i (zero-based) spins on location SPIN+i\n" +
			"let RUNNING = SPIN + NUMAGENT;  // Accounting of live agents\n" +
			"let NUMELEM = RUNNING + 1;\n" +
			"\n" +
			"// Create workers and start them all spinning.  We set atomic slots to make\n" +
			"// them go into a wait, thus controlling the waiting order.  Then we wake them\n" +
			"// one by one and observe the wakeup order.\n" +
			"\n" +
			"let rs = [];\n" +
			"let ws = [];\n" +
			"for (let i=0 ; i < NUMAGENT ; i++) {\n" +
			"	let w = createWorkerFromString(`\n" +
			"			onmessage = function(e) {\n" +
			"				let sab = e.data[0];    \n" +
			"				let ia = new Int32Array(sab);\n" +
			"				Atomics.add(ia, ${RUNNING}, 1);\n" +
			"				while (Atomics.load(ia, ${SPIN + i}) === 0)\n" +
			"					/* nothing */ ;\n" +
			"				var ret = ${i} + Atomics.wait(ia, ${WAKEUP}, 0);\n" +
			"				postMessage([ret]);\n" +
			"			}\n" +
			"	`);\n" +
			"	w.onmessage = function(e) {\n" +
			"		rs.push(e.data[0]);\n" +
			"		check_results();\n" +
			"	}\n" +
			"	ws.push(w);\n" +
			"}\n" +
			"\n" +
			"let ia = new Int32Array(new SharedArrayBuffer(NUMELEM * Int32Array.BYTES_PER_ELEMENT));\n" +
			"ws.forEach((w) => w.postMessage([ia.buffer]));\n" +
			"\n" +
			"setTimeout(function() {\n" +
			"	// Wait for agents to be running.\n" +
			"	waitUntil(ia, RUNNING, NUMAGENT);\n" +
			"\n" +
			"	// Then wait some more to give the agents a fair chance to wait.  If we don't,\n" +
			"	// we risk sending the wakeup before agents are sleeping, and we hang.\n" +
			"	sleep(500).then(function() {\n" +
			"		for (let i=0; i < NUMAGENT; i++) {\n" +
			"			sleep(500).then(() => Atomics.store(ia, SPIN+i, 1));\n" +
			"		}\n" +
			"	});\n" +
			"\n" +
			"	// Wake them up one at a time and check the order is 0 1 2\n" +
			"	for (let i=0; i < NUMAGENT; i++) {\n" +
			"		sleep(200).then(() => assert.sameValue(Atomics.wake(ia, WAKEUP, 1), 1));\n" +
			"	}\n" +
			"\n" +
			"	enterEventLoop();\n" +
			"}, 500);\n" +
			"\n" +
			"function check_results() {\n" +
			"	if (rs.length == NUMAGENT) {\n" +
			"		for (let i = 0; i < NUMAGENT; i++) {\n" +
			"			assert.sameValue(rs[i], i + \"ok\");\n" +
			"		}\n" +
			"		exitEventLoop(ws);\n" +
			"	}\n" +
			"}\n" +
			"\n" +
			"function waitUntil(ia, k, value) {\n" +
			"	let i = 0;\n" +
			"	while (Atomics.load(ia, k) !== value && i < 15) {\n" +
			"		sleep(100);\n" +
			"		i++;\n" +
			"	}\n" +
			"	assert.sameValue(Atomics.load(ia, k), value, \"All agents are running\");\n" +
			"}\n";
    }
    window.addEventListener('load', function(e) {
      async_test(function(t) {
        run_in_iframe_strict(test262, attrs, t);
      }, 'IFrame (strict): js/test262/built-ins/Atomics/wake/wake-in-order.html');
      async_test(function(t) {
        run_in_iframe(test262, attrs, t);
      }, 'IFrame: js/test262/built-ins/Atomics/wake/wake-in-order.html');
      async_test(function(t) {
        run_in_window_strict(test262, attrs, t);
      }, 'Window (strict): js/test262/built-ins/Atomics/wake/wake-in-order.html');
      async_test(function(t) {
        run_in_window(test262, attrs, t);
      }, 'Window: js/test262/built-ins/Atomics/wake/wake-in-order.html');
      async_test(function(t) {
        run_in_worker_strict(test262, attrs, t);
      }, 'Worker (strict): js/test262/built-ins/Atomics/wake/wake-in-order.html');
      async_test(function(t) {
        run_in_worker(test262, attrs, t);
      }, 'Worker: js/test262/built-ins/Atomics/wake/wake-in-order.html');
      async_test(function(t) {
        run_in_shared_worker_strict(test262, attrs, t);
      }, 'SharedWorker (strict): js/test262/built-ins/Atomics/wake/wake-in-order.html');
      async_test(function(t) {
        run_in_shared_worker(test262, attrs, t);
      }, 'SharedWorker: js/test262/built-ins/Atomics/wake/wake-in-order.html');
    });
  </script>
</html>
